Okay, so I'm sure everybody's heard of the elephant in the room. I just caveat that to start with so this is just a play on that phrase. So when we're all here I'm presuming everybody in this room has come to cryptocurrencies for some kind of really key fundamental points and you know, those are on the screen decentralization, censorship resistance, trust-less, open, and private. These are fundamental to why we're all here why we're all participating in this wonderful shape of the world at the moment. And there's this one thing that really really gripes me and it's such a fundamental part to the whole ecosystem which is of course mining. Now mining, we all need mining its fundamental to how cryptocurrencies work, however, what's happened ever since that, you know going back to the early days of Bitcoin, is we've had pool mining and pool mining has a number of issues with it.  

So before we go into exactly how pool mining works, let's just remind ourselves for the answer into the space mining and how it works. Let's just go over a couple of the fundamentals. So a transaction, Alice wants to send Bob some money. Well, as we all know it doesn't directly go from one computer from Alice's computer to Bob. What actually happens is it gets broadcast to the network and it gets bounced around nodes in the network. And what they do is they add it to the transaction pool. So in this picture here we have Alice to Bob's transaction the yellow-orange transaction sitting in the transaction pool that every node can see.  

Okay, so one of those nodes happens to be a miner. What does he do? He grabs as many transactions from the pool that he can to basically make what's called a block template. Now in this example, he's grabbed all of them obviously the pool can have loads and loads of transactions in it and back to ArticMine's talk obviously a miner chooses transactions to not incur a block penalty, so they won't always choose every transaction. As I said, they create these block templates from those transactions they've picked and as you see in the green transaction at the bottom. That's what's called the coinbase transaction that's the transaction which when this when and if this block gets mined that miner will get paid out the fees from the other transactions and the coin base reward. So that block template gets reduced into what's called a block hashing blob and that is the thing that a miner mines on to Howard's point -- the inefficient loop. And they keep doing this inefficient loop until they find a winning nonce, and then they put that nonce into their block template, and they broadcast that to the rest of the network and hopefully, they got it in first and before anybody else managed to mine a block and if they did then they're going to get that coin base reward. And that's solo mining for you.  

So pool mining. In a similar fashion we have a pool of transactions in the transaction pool. Again, we have the yellow Alice Bob transaction. Now the pool server the red computer in this example, does the same thing as a solo miner in that they grab a load of transactions, and again, like I said here this is an example where they're grabbing all of them but there could be more and here's one of our problems with pool mining, which I'll come on to. And so they grab those transactions, they make a block template, they add their own coinbase transaction into the block template, they reduce the block template to a block hashing blob, and in this scenario, the pool server doesn't do the work on the block hashing blob they distribute that to their pool miners. The pool miners receive the block hashing blob - they actually receive their own block hashing blobs, but that's a detail that not relevant here - and they send back to the pool server the nonce and the result hash that they managed to achieve.  

So the important point here is the miners haven't seen the block template at all. They've got no idea what transactions are in that block template. The pool when it gets back one of the many responses from the pool miners, may have to validate obviously that, and don't forget that the results from the pool miners a to a lower difficulty than the global difficulty, but of course one of them, hopefully, hashes that hashing blob and if they hash that hashing blob and the result hash happens to meet the global difficulty then the pool server can then add the nonce to the block template and distribute that to the rest of the network and the pool gets the payout. And of course, then the pool is responsible to pay out all the individual miners for their contributions. This thing is really annoying. Here we go. So what are the key problems with this? Well, obviously we have to trust the pool. We have to trust them, first and foremost from the miners' perspective, that they're paying out fairly and honestly this is the what you mostly see on the likes of Reddit like people moaning about various pools not paying them their fair share. There's been earlier pools that have skimmed shares so that the pool themselves gets more of the profits.  

But for the rest of us, for the network as a whole, we have to trust that they are actually a good-faith actor. And why do we have to do that? Well, we have to trust that they're a good-faith actor primarily because they're centralized obviously. They're the ones that are in control of creating that block template. They're the ones that are selecting those transactions. We have to trust that they're actually not performing attacks, like a 51% attack, because let's be honest, the pool distribution is not that high. There's been many a time when you know one or two colluding pools could control 51% of the hash rate. In fact quite recently before our last, not this last fork but the fork before there was a very real risk that a pool could have had a 51% of the hash rate.  

Another subtle thing here. Is that there we have to trust that they're mining the correct chain. Don't forget the miners that are participating in a pool, they've got no idea. As long as they're hashing the right algorithm, well, there can be many Monero forks that use exactly the same hashing algorithm, they and we have to trust that the pool is actually giving block hashing blobs that are for the Monero chain. Now, I don't want miners to be mining some you know Monero fork. The miner themselves may be very invested in Monero and wants to ensure that they're helping the Monero network. 

And critically is the transaction censorship. We have no miner or us, nobody has any observation as to if there's any transaction censoring going on. In fact, there's been a couple of things recently that came up. I forget which currency, it was I think it was Zcash. Or was is Zcoin? One of them where there was a pool that actually was discovered to have censored some transactions. So it's a really fundamental issue.  

But why are we using them? Why are we using these pools? Well, from a miners' perspective it's really down to payout variance. At the end of the day, whether you solo mine or mine in a pool, ultimately, you will get the same payout it's just how frequently you're going to get paid. Now if you want a regular income pool mining is great. There's also ease of use so for people that don't want to set up a node, they don't want to go through the problems of that like literally installing a miner on your computer pointing at a pool is incredibly simple. You don't need to know anything you literally you follow a three-sentence guide that's on every pool website and you can be mining in a matter of seconds. The other thing is maturity obviously. There is really, pool mining has been around right from the start of Bitcoin and the particular type of pool mining that we've got at the moment is tried and trusted. I mean it's very very mature, but the critical thing is there's a real lack of alternatives which well come into now.  

So my personal favorite is P2Pool. This is one of the early Bitcoin pool implementations and it is extremely decentralized there is no central authority here at all. The way that it works is essentially every miner is running a node a P2pool node. They're also running their Bitcoin node, and they are creating their own block templates, and they are, and they are basically mining to what's called what P2P calls a share chain. What happens here is, there's essentially all, everybody's essentially solo mining but to a lower difficulty and they're distributing to the other participants in the P2Pool. One of the great things about this is obviously the coin base transaction that they're constructing pays out other participants in the pool as well. 

So there are a couple of drawbacks though with P2Pool the most obvious one, of course, is your, you've got an extra P2P overhead. Not only you're running your Bitcoin P2P node, you're also running the P2pool node. And also there's like high traffic on a P2pool node because you're essentially mining to a lower difficulty to basically create a block every 30 seconds as opposed to every two minutes. So you're gonna get a lot more traffic over that network. There's also the consensus overhead which because of the faster block time is problematic. As I've mentioned, you've also got the full node overhead as well. There's also the problem of poor difficulty distribution and so with our common pools in play today, you can mine with 50 hashes a second or 50 mega hashes a second and you're still going to both get fair payouts on your contribution. Unfortunately, P2Pool is a little bit, a little bit more difficult than that and actually, you really want all of your participants to be roughly the same. Have a nearer hash rate capability each.  

And then the last important point is really there's only a single implementation. I've spent a lot of time looking to see if anybody else had been doing one. I spent probably about six months of my own time trying to build one for Monero and that was that would have been hopefully what I was presenting here today, but you know things change. Lots of people told me no you're going to run into the consensus problem, and I was like, "No, no. I've got that sorted. I'm sure I've got that worked out in my head. It's not a problem". And sure enough, I should have listened to smooth and Howard and gingeropolous, but instead, I wasted six months of my life. That's fine.  

We've also got BetterHash, by Matt Corollo, a Bitcoin developer. Now he came at this from a slightly different angle. I mean this like the same problem he's another like-minded person like me. Like it's ridiculous, it's honestly insane, that we've got pool mining in our ecosystem of cryptocurrencies and the way it works now. It's absolutely insane. So he again, and more saw a problem for Bitcoin obviously, and so he came up with a protocol to try and tackle this for Bitcoin and the way he did this was with essentially separating the two parts of what pool mining does which is separating the work and the payouts. He does this by essentially allowing what he calls a controller, I call a proxy, I mean, it's very similar to our current node proxy servers. Basically constructs the block templates. Great, so we get away from the transaction censorship issue.  

However, he also replaced a stratum, some people like hate stratum, is undocumented. It's thrown together but honestly in my view, it's such a simple protocol people slightly change it to their own needs, so what it's not hugely documented. I mean, there's nothing in there it doesn't, it doesn't really need replacing. But one of the other great things about the way that he's devised is it's actually a very flexible protocol. It allows you to work in a number of different ways it allows you to stitch together your ecosystem in a number of different ways, which I won't go into, but they're mostly everything to do with better hash is definitely targeted at the Bitcoin ecosystem. That being ASIC miners. 

So it's got a couple of problems and the first one here which I actually think, I don't know if anybody's followed much of the press on this, but he got pretty slated by a couple of other Bitcoin devs which I thought was pretty unfair because although better hash doesn't solve all of the problems, like in the same way that P2Pool does, from a decentralization perspective, it does solve one of the problems and which is probably with the well I consider the most important problem which is the censorship piece. So it does still, BetterHass does still have a centralized payout logic so the miners still have to trust the pool that it's actually giving them their fair share. And that's because the coinbase pays to the pool directly. 

Carries quite a lot of complexity by throwing away stratum and the way that pools currently work. It does introduce a huge amount of complexity, so whenever you're introducing extra complexity, it's not just pools that you're talking about changing, it's also the miners, the miner software. It's talking about the actual Bitcoin nodes as well. So there's a significant amount of changes that are required to actually implement on top of the better hash protocol. Less important, the fact that it's rather untested at the moment, obviously we don't all want to jump onto something that's completely untested, but I wanted to add it in there because I think any kind of changes that have, and particularly for a currency like Bitcoin that's got so much money involved like we wouldn't all want to jump on something that's completely untested tomorrow. And like I've said as well, in multiple times. It's a very much geared towards an ASIC scenario because of course, we wouldn't have to remember with ASICS, ASICS don't run full nodes. ASICS aren't clever enough to be able to select which transactions are going to go into a block template. An ASIC is just given something to hash, it hashes it. It sends a result back. That's all an ASIC does.  

So where I kind of netted out with my months of pain on P2Pool consensus which I think we should do. I'm certainly going to implement it into a pool which I've authored and into a miner which I'm spending some time on now. It's a stratum extension just take stratum as it currently works now like it doesn't require a great deal of change to do what I'm going to propose here. So all that the pool need do, is actually send a coinbase transaction in stratum. At the moment it's sending a block hashing blob, now it can just send a coinbase transaction. What then happens is your miner takes that coinbase transaction and it creates its own block template in exactly the same way as solo miner does. But where solo miner obviously adds their own coinbase transaction in this situation they're going to take the pool supplied coinbase transaction. Oh, one thing I glossed over, the coinbase transaction that gets sent back ideally it should be a multi-output coinbase transaction. So at the moment Monero only has one payout on the coinbase. I did through my P2Pool work, I've got a patch for Monero which allows it to payout multiple and coinbases. 

And this is quite important from an auditing perspective. So the pool sends a miner a coinbase transaction, and the miner creates his block template, creates his own block hashing blob, mines it to the difficulty that the pools expecting or whatever the miner decides that he wants to hash it to. And critically the miner can also submit the block here. The miner doesn't have to send the block that he's created back to the pool for the pool to submit because that's another problem. If you're sending a block back to the pool, you've got to trust that the pools going to submit it. So essentially, you're putting as much power as you possibly can in control of the miner and luckily we can do this because we don't have ASICS every one of our miners is running from a Windows or a Mac or a Linux machine whether they're running you know twenty GPUs, or they're going to be doing loads of CPU mining we're doing it on computers, so we can run full nodes, and we can we have a lot more control. 

And critically when you think about it, the changes required for this are negligible. They're actually really small. So, of course it still has the same problem that Matt's BetterHash has which is, we're still trusting the pool to do that share distribution. It helps having the multi-output coinbase transaction but ultimately if the only thing worried about is a pool being in control of that shared distribution, obviously miners can work out whether pools are behaving there or not. Everybody knows what they're mining. They see what the network's mining. They see what the pool's mining they can calculate themselves and this has happened in the past actually In earlier days with pools where miners have worked out hey why I've got three mega hashes, and I'm not getting the right payouts. You can work it out. So it's not a huge problem the biggest issue is obviously miners now need node access now, I don't know how many people know miners that are out there but I can tell you just from my own first-hand experience on our channels like Reddit and Stack Exchange, most miners are only in this game for the money and so like them needing to run a full node whilst I might say, "Well, that's absolutely fine of course is the reality of it is some miners are gonna kind of moan about that", and it's a problem. But I think this is the best way forwards and this is certainly what I'm going to be implementing over the next couple of weeks. And hopefully some other pools will follow fashion because I think whilst, it's not perfect I think it solves a couple of really critical issues. 


So questions? 

Have you seen how grin includes a stratum server with every full node?  
Yes. Yes.  

What do you think of that?  

Yeah, that's there's lots of interesting ways there's lots of I mean, I'd love it if everybody was just solo mining personally, but uh.  

It's like you're your own pool so you're solo mining but not so. Some of the medium-sized miners could you know, I think because sitting up stratum your own stratum servers such a pain in the ass. I've heard a lot of people let that stop them from doing that. What do you think of possibly putting stratum in Monero full nodes?  

So yeah, that's, that's certainly, that's certainly one thing. There's also a competing fork which has just added exactly what you're describing a stratum mining server port. They call it a port server into their actual node as well. I mean, I have doubts that that's going to solve enough of the problems. Like, we have to look at all the reasons that people are using pool mines now and if we can do the minimal changes to the current ecosystem but get rid of some of the really big problems, I think that's for me that that seems to be the most sensible approach. Like, I think that's one way that we're going to get a lot of miners updating the way of they're mining. If they literally, the only change they've got to do is run a full node then I think that's great. 

I have a question over here. I'm curious, I am assuming that you're aware of the Bitcoin, like API function that gets block template. That was introduced I mean that was introduced a long time ago and it allows minors to populate blocks with transactions, right? and as far as I know, no one uses it because miners are totally apathetic, and they don't want to run a full node in general. So I'm curious. What do you expect Monero miners to behave significantly-differently than, then the lack of uptake that Bitcoin had with this kind of similar addition? 

Well, so Monero's got exactly the same function, `get_block_template`. That's how solo mining works and that's the function that all the pools use. They use the exact same function, Bitcoin and Monero, calling `get_block_template` to basically get a template to mine on. The problem is that you can override that template you can create your own block template. You can select your own transactions to go into a block template. That I mean, that's one of the problems with pools. I kind of lost track on where I was going with that but really the, yes, I mean, you point out something which is essential, a miner has to run a full node in my scenario of an extended Stratum protocol whereby the pool doesn't create the block template. That's really the only problem that we're trying to solve here is the pool creating the block template.  

If there was some theoretical extreme way to force solo mining onto the network at like the consensus level like if you had to expose your private key to sign a block or something. I mean, if there was some way to force people to not pull mine is that something you would be interested in pursuing? 

[laughter] I don't like you. I don't like any kind of extreme actions, I'll say that. And I do think the mining ecosystem is important like it's a big part of cryptocurrencies it is one part of the triangle and I think it is really important that there is a market for them, and they need pool mining, okay. Yeah, I'd love it. If I'd love if every participant of Monero was mining? I'd love it if every wallet mined and that actually every user was essentially a miner. In the ideal, yeah, that'd be fantastic. The reality is we're not in that place, you know, there is this segment of mining in our ecosystem, and we do need to look after them but let's look after them and welcome them into the ecosystem. But let's do it responsibly is what I'm saying. 

Just a quick question, so once you're done implementing the pool, will that be a public pool that everyone can mine too?  And then a follow up to that with the multi-output coinbase payout. It's my understanding that Monero is limited to 16 outputs per TX. Will that have to change for this or will you do multiple coinbase TX's? I don't actually understand how that works in practicality.

No, it's a really interesting point that actually because my brain went through exactly the same thing actually, early on. I was like, "Yeah. Well, the problem is that the pools gonna need to pay out?". I came to this question when I was working on my P2Pool, and I forget who it was on IRC, but they were like, what you think is actually really simple. All you do is you wait until miners hit a certain threshold before you pay them out. So the coinbase transaction patch that I've got that I've been using for testing P2Pool, as you say, only outputs to 16 outputs, but the way that the Pool works is obviously it waits until it's got you know X amount, you know, 16 miners that reach a certain threshold and then it pays those out. So you would never get your payout until you reach a threshold so that you're in that sixteen, but yeah.
