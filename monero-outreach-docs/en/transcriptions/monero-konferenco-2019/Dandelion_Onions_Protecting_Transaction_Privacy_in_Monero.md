# Lee Clagett 
_**Dandelion Onions: Protecting Transaction Privacy in Monero**_  

Lee Clagett is a programmer whose primary experience is in computer networks/security, and has been a funded code contributor to the Monero project since 2016. He is most active in the PoW tweaks, upcoming "light" wallet server, and increasing transaction broadcasting privacy for Monero.

**Dandelion Onions: Protecting Transaction Privacy in Monero**  
_Lee Clagett, The Monero Project_  
[youtu.be/bxQ0ic1Fccs](https://youtu.be/bxQ0ic1Fccs)  

[MoneroTalk](https://www.youtube.com/channel/UC3Hx81QYLoEQkm3vyl4N4eQ) w/ Josh S (Airfoil Capital) & Lee Clagett (The Monero Project) at MoneroKon 2019! - [youtu.be/M9EKUtHpDzs](youtu.be/M9EKUtHpDzs)  

_**Abstract**_  

The Dandelion protocol and Tor/onion routing are the most common techniques for masking the origin IP of a cryptocurrency transaction. Both of these techniques have limitations unless further mitigations are implemented. The Dandelion protocol protects against incoming sybil adversaries, but not passive ISP monitoring. Tor protects against incoming sybil adversaries and basic passive ISP monitoring but increases the threats of eclipse attacks and is susceptible to statistical bandwidth monitoring techniques. Monero will attempt to mitigate against all these threats by using Tor/onion routing only for peer-discovery and “whitened” stem phase (Dandelion++) transaction broadcasting. The talk is a discussion of these threats and mitigations, and the current implementation progress in Monero.

_**Transcription**_

Oh, there we go, alright.

So, first thing I want to point out, that second link, which is a URL will hopefully, eventually contain the slides. So those of you watching the live feed, don't get too excited, that link doesn't work yet. And, as the title suggests, this talk will be about IP linkability to transactions.

That is, there we go.

So, the top portion is pretty much what's been implemented today, so far, but for chain privacy. The bottom portion is what the focus of this talk will be on and that is on protecting privacy on the source IP of the transaction. So the ones highlighted in red are pretty much what this talk is going to be about. The opportunistic encryption is something that will probably also go into Monero eventually, but that's just going to take some more time to research as well.

And because this is Monero we aren't just doing [I2P](https://geti2p.net/en/) and [Tor](https://www.torproject.org/download/), we're also adding white noise, and possibly something like [Dandelion](https://arxiv.org/pdf/1701.04439.pdf). It's not going to be Dandelion++, I should give that caveat, but there will be some additional mitigations for the things that Josh just talked about, with the, anybody that can observe multiple points on the total internet can, well, we'll just get into that I guess, as we go through the talk.

So these are sort of the three main threats that we're trying to address. The first one is probably not as well known as the last two. The first one is anyone that's attempting to make many connections throughout the network, in order to infer who is the possible origin. The next one is probably what most people would think, the [ISP](https://en.wikipedia.org/wiki/Internet_service_provider) is just sort of monitoring your network passively. And the last one is anyone that's able to monitor multiple network points, that also enables even more information to be gleaned.

So, again the Dandelion paper is probably the best resource on getting information about how this type of attack works, but effectively you make many connections to the network, and you try to learn the network topology through a P2P administration protocol. There's some basic bookkeeping in the protocol on how to, you have to spread information about your peers, about peers that you've seen, and this sort of leaks information. And also pretty much every transaction or broadcast will leak information as well because you can sort of see how the information is flowing through the network if you have many connections on the network basically. And it's all statistical based so it's not guaranteed to work, and that's, and again, see the details on the Dandelion paper. And so, to mitigate this, Dandelion++ proposal is designed to mitigate against this very specific type of spy, and I2P and Tor would also mitigate this issue but in a very different way.

All right, so now, the ISP spy, I think the first bullet-point most people are probably - is what they would probably guess - the ISP could do some sort of deep packet analysis where they actually process your Monero P2P links and see that "Oh, this person never received this transaction but only transmitted it". This would sort of leak information that you're probably the source of it. So the obvious mitigation to that would be encryption. The difficult part here is we're encrypting something of a very specific size that gets immediately sent to everyone publicly. So these two features are sort of working against each other. And even worse, so [moneromooo](https://github.com/moneromooo-monero), one of the other contributors added some padding to help mitigate this, so it pads up to the next size boundary hoping to sort of conceal this leakage. The problem is that Monero at its peak had one transaction every 5.6 seconds. So there's a strong correlation between the size of, oh, you know what, I don't know why I'm describing this to you when I can show you. There we go. 

So this is a [Wireshark](https://www.wireshark.org/) capture, this is on main net, I don't mess around with testnet stuff. This is a single connection over main net and so the black bars are the total bandwidth and the red bars are the outgoing bandwidth. And so what you'll notice is that there's lots of periods of inactivity and short bursts. And so, well there's some awesome Gimp skills but I don't even have arrows I couldn't figure that out, honestly [laughter]. But what you can see that the over there to the left there are two block broadcasts that look very similar and there's no transactions downloaded because these are so-called thin blocks or [fluffy blocks](https://web.getmonero.org/resources/moneropedia/fluffyblocks.html) I think is what we're calling it. So there's very little transmitted, but, again, it still looks very, well, I guess I didn't explain that part, this is actually on a one-second granularity, the amount of bandwidth, so if you tighten up the granularity, you can actually, on the far right, it looks very similar except that this particular peer then downloaded some information from me. 

And then, just to show you even further this is a zoomed-in portion of the, oh yeah I didn't tell you this part I actually did send a transaction during this time interval too. So I sent real money over this, just for this talk here. So, this transaction I sent was about 2.5 kilobits, and you can see roughly from the chart that, with overhead of the protocol, you see a spike of exactly that amount going over the link. And you can also see there's other periods of inactivity and there's also periods of other activity that can't possibly be my transaction due to the different spike levels. 

I don't think you can see this on, that's probably a little hard to see, one of the interesting things about this connection, I had thirty-four connections at the time, and I actually received my own transaction from this person before I sent it out,  which is kind of interesting. You can actually see that in the graph there that's kind of an interesting. So it is, the Monero protocol apparently is a bit chaotic and it's very very, it uses way too much bandwidth I guess would be the simple way to explain it. So now this is the same time period but all of my incoming connections, I botched it so I didn't get the outgoing one. I had about twenty-four incoming connections. 

And so this is trying to give you the view, if you were running I2P or Tor, this would be kind of what the ISP would see, they would see similar peaks and valleys. So right away I mean you can almost tell immediately I could tell you when I'm running a command where I'm asking every peer, "Hey what are the peers that you see", "I get a big spike of drama coming back at regular intervals", and you can pick this out even over Tor, you can spot it pretty much immediately. Now I do want to state that if Tor, Tor does some padding in the cell, so it will look slightly different but the padding is pretty minimal. And so again this is the same data points. It will be harder to pick out over Tor though, because, and I guess I didn't explain that part I guess I just kind of assumed that. The difference between Tor is that all of your connections are going to be going over a limited number of [TCP](https://www.webopedia.com/TERM/T/TCP.html) connections, so that's why the graphs will look different, there'll be more noise, so to speak, for the ISP to filter through. 

All right, so, as far as the ISP spying goes, encrypting data, whether it's the P2P links [inaudible] or I2P and Tor, I would argue it's a partial solution only because you're somewhat relying on luck. If you're able to hide anything it's because the protocol just happened to be sending something at that particular time period that masks what you're doing. Which is why in my original forum proposal I proposed adding white noise over I2P. 

And so now we're talking about the, our favorite that Josh kept talking about, the global passive adversary. The problem with this adversary is that they basically can do a better version of the first spy. If they're able to see multiple points in the network they're not inferring the network topology, they're just seeing the network topology. So this is really hard to defend against. And so, as an example of something speculative they could try to do, even with the white noise, you could try to do the first technique where they make many connections over Tor and then try to de-anonymize Tor users. Now that's, I mean I don't want to say that that's easy, but it is, within all the academic literature that is theoretically possible. 

And so the mitigations, well, that's that Dandelion++ thing, that may or not help somewhat. I mean, honestly if you really were concerned about that you'd probably have to go with something more similar to a mixnet, but, we'll get into that. 

So what is [Dandelion++](https://arxiv.org/pdf/1805.11060.pdf)? Hopefully, I'll give a quick explanation of that. The idea here is to, well actually they have two goals, especially in the Dandelion++ paper. They're trying to, I guess I'll just show you everything they're trying to do, really, provide a lot of information there. They're trying to prevent basically metadata leakage about the network information. So again, they're trying to prevent against the first type of spy that's making many connections. So basically, every transaction in the first phase, that's the stem phase, is only sent over one connection. The idea there is it reduces the chance for any of these spies to learn about how the transaction is flowing through the network because it reduces the probability that they are receiving the transaction in the first anonymity phase. The second thing is they're choosing outbound connections in the first phase because that, again that limits them targeting a person where they're making lots of incoming connections to you, in order to fill your connection table to really observe. So that basically you have to send a transaction through them. And then so, the idea is, after it goes, now mind you, this is within the existing P2P network, so after it makes through several hops only selecting outbound peers, eventually, at some point it gets spread in the normal fashion. By normal I mean Monero can still improve what it does there too. 

And the other thing I did want to point out, which I didn't think about when I first started this, and this is the last bullet point, which is probably one of the more important ones, Dandelion++ actually makes it easier for the ISP's and these other adversaries.  It wasn't obvious at first, but one of the things is the ISP can see which direction the connection is made. So they immediately know, if they're following the Dandelion protocol, the transactions are only flowing in one way, so the heuristics of filtering out the noise gets even better. And the chaotic like, I'm receiving my own transaction before sending it is never going to happen. So it actually makes some of the analysis of the other spies easier. But for various reasons, Monero is still probably better at, not better, better off by implementing it because that type of spy is probably going to be the most common, but. 

Now, I2P and Tor, I think Josh had talked about this already. The main idea of I2P and Tor is just to break apart who the two endpoints of the communication channel are. So, that's why Monero has always had this on the roadmap because if they use I2P, the idea would be who's ever receiving the transaction wouldn't even know it. So that first type of spy is pretty much completely mitigated because they don't even know the IP of the sender, of the other person on the other end. For some of the more advanced people, particularly the passive adversaries, they may be able to still infer some information. 

Okay, now, what is [white noise](https://en.wikipedia.org/wiki/White_noise#Computing)? I've been mentioning this a lot. This is mentioned in many places in academic literature, so this isn't anything new. Basically, at regular intervals send a fixed amount of data. If you have no data to send, you just send, it doesn't really matter what you send, you just send anything, because the entire link is encrypted, so anyone observing it doesn't know whether you're sending just dummy data, or whether your sending an actual transaction, or part of a transaction. And so, one of the things that is also isn't obvious, and a great paper came many years ago, is, the interval needs to be randomized because you can actually detect which branch was taken in the code based on the timings that come out because the intervals wont be exactly precise, they'll be milliseconds off. And someone actually did a very well test over several router hops and found this out, that this actually is observable several router hops away.

So, Monero will have you covered there eventually as well, hopefully. 

So what am I actually saying that will, you know, what we're actually doing in Monero. So the first proposal I think will be, eventually MoneroMoo, myself, and several others will probably have Dandelion++ over IPv4 and 6. For a number of users, they don't even want to run I2P, that will be an option that will at least prevent some of the more basic type spying that we've been seeing on bitcoin and these other networks. 

Now, for anybody that wants a little bit more, these bullet points are more than probably more of a guidance. I don't think that this is going to be the final solution. The idea is basically, and I don't really want to call it Dandelion++ because it's usually taking some of their techniques and making it harder to, it will create really more plausible deniability on where the origin was coming from. So, what I have right now, at least on my working codebase, is 3 kilobytes of noise every 10 to 15 seconds, but only choosing, you know I have in it, but only choosing two senders. And so the transactions will either go out to one of two senders, kind of like in Dandelion++, and eventually, the receiver over I2P or Tor transfers this into the IPv4 or IPv6 network. The catch is, we have to like pretty much - I'm calling these zones because they have to be pretty much have to be completely isolated to make sure that there's no metadata leakage across the zones, including - that's why the first bullet point, separate mempools,  if we commingle the mempools, someone that happens to probe your node about something can then observe that "Oh you've seen this transaction before. How did you know about it? I've never seen it yet." kind of thing. So and this pretty much just highlights, I think, what I've already talked about. 

One of the interesting things - the reason I started talking about Dandelion++ is, well there's multiple reasons - one of the things this is it, my original proposal was sending white noise to every peer. This had the very bad downside of a lot of bandwidth usage. Or you up the delay interval, but then the transactions take longer to propagate. So, by only using something similar to Dandelion protocol, you're using less connections to send white noise over. The other advantage it has is, in this mode, anybody that was a global passive adversary, they would be forced to effectively do the first spying technique, they would have to make tons of connections over tor in hopes to de-anonymize users. At that point, they would then have to then try to infer whether the transaction came over Tor, and match it to and endpoint, and then de-anonymize that endpoint. 

And so the plausible--, and unfortunately, this is kind of really deep within the Dandelion++ paper, but they sort of talk about this tradeoff. One of the differences between the first Dandelion and Dandelion++ was the first paper only had one incoming and one outgoing in the anonymity phase, whereas the new one has two incoming and two outgoings to the transactions. The idea there is if someone does learn the network topology if you only have one incoming route and one outgoing route, it's actually the worst-case scenario statistically. So, I may actually propose that basically, every outbound Tor connection is white-noised over a longer interval. And that will then create, you have a ton of incoming nodes that could be plausible deniability of - which link one of these transactions came over - mixed with yours, and it goes to only one of ten. So that will be something that we'll have to probably discuss with Monero Research Lab. 

Now, to talk about like all the downsides, which there's a lot. The first one is, you get the maximum privacy if you set up a Tor exit node, or the similar concept than I2P, which right now is manual, and that's probably not going to be satisfactory. They're always automated, but, yeah, it's going to take a lot of work. There's also the obvious downsides of all the bandwidth this is using. That's pretty much why Tor doesn't use white noise. Now, their cases are different. They're trying to protect Facebook and Youtube traffic for some reason, okay, but the amount of white noise you would have to do to protect that traffic is got to be just absurdly high, I don't really know, I've never calculated it. The other downside is, this has the effect of slowing, not only does this have the effect of making the transactions, if you're trying to get your transaction in a timely period, that's just not possible unfortunately with this technique, and it also, it drops the throughput because basically you have to wait and have a queue, and this creates a, it's the equivalent effect of having, you can only send transactions at a 3.93 kilobit connection. That's what I'm simulating here in a very, in a very bad way. 

So the other thing that's kind of unfortunate is these passive adversaries that can multiple, multiple connection points, this sort of regular intervals of white noise probably makes it easier for them to develop the connection flow as it traverses the internet. I don't see a way around that if you're using any P2P network or any TCP connection that's long-lived and it's constantly sending data. I mean, every time you send a data, it's because Tor doesn't have any of these counter-measures, there's statistical information that's being leaked either way. 

Now, I've also, I guess I didn't cover this point. Monero, at least currently in the codebase, is only doing transaction broadcasting in a few administration things over Tor and I2P. If we did the full protocol, you would get more cover traffic but the downside is, there's a bunch of places where we've blocked bad actors and you really can't block incoming Tor transactions because they're just, I mean is just some person who created a new public key, I don't know who he is. 

Now the other downside is, it's easier to create more sybil cases, so, if you're worried about [blackholing](https://www.techopedia.com/definition/23218/blackholing), which has been an ongoing discussion from the original Dandelion paper, this could possibly make it worse because it's easier to create an alias over Tor and I2P, you don't need a new IP address, you just need to create a new public key.

Now, this last point, yeah well, I don't think we need to cover that cause that's really deep in the details of how it's implemented and that's going to be an ongoing effort I think anyway. So the important thing is probably what is the status of Monero right now. 

So we've added [SOCKS](https://en.wikipedia.org/wiki/SOCKS) support, which is probably, not a lot of people probably know what that is, other than the wallet and daemon both have some understanding of an [onion](https://en.wikipedia.org/wiki/.onion) and I2P address and that's as of this last release that just came out. So, if you were to set up a Tor exit node, you can have it forward to your daemon and your wallet can connect to it directly from the wallet over Tor. It connects to a Tor daemon and forwards all the traffic over Tor. You can also, if you knew some cool person that was allowing you to forward your transactions over Tor and they gave you their hidden service, you can do that already now but again though, none of this is automated. 

The white noise is in progress. I have a laptop somewhere that has a lot of that in. Actually, it's pretty much done. And one of the advantages-- I managed to get some optimizations in there as well, so that's a nice benefit, there'll be a partial Dandelion++ implementation coming out. By partial I mean, the bits needed so that someone doesn't have to immediately refactor all the code I just did, will be in there. And I think this proposal - what I'm doing over Tor and I2P - will definitely have to change as time goes along because there's just a lot of details that need to be worked out. But I think this will be much better than what Monero's doing right now which is pretty much nothing, so, there's that [laughter]. And, I think that is, yep that's it.

[Question from Audience Member:]
I've just got a quick one about the mem pools per zone idea. Do you see that causing problems with transaction censorship if certain miners are running nodes for clearnet and for I2P and Tor, where they can see transactions between the distinct zones and choose to include only clearnet or only Tor and I2P, etc.?

So that's what the blackholing was referring to, the Dandelion paper discussed that as well. The Dandelion paper actually suggests separate mempools as well, and that's what the reference implementation did, and that is a problem because if you're only sending it to one node for several hops before transmitting it to all, any one of those nodes can just block you. So there is a process, and I didn't discuss that part with anyone in the Dandelion++ protocol, that is part of the, there's an embargo timer. So each node who's honestly behaving sets a timer, and if they don't see that transaction come back to them, they're supposed to fluff it out. Now, I believe that's how it works, I haven't implemented that part at all, so, but it's something along those lines. So that's discussed across, mainly probably in the original paper but probably in the second one as well. 

[Question from Audience Member:]
You showed the traffic graph while you were connected to Tor?

No, no I'm sorry, I should've clarified that. I was trying to show what it might look like over Tor, so I was still running the same protocol. So the major difference is going to be the incoming, and outgoing will be much more confusing and then there'll be padding as well. So it will be much harder to infer anything. The problem though is, we have decided, at least temporarily, to only run administration traffic and transaction broadcast over Tor. So, there will be a lot less noise I think. So we either have to do everything over Tor, with the other downsides that you can't really ban - we have a blacklist locally in the node for bad actors over these networks - and there's really no way to do that. So that's, I'm sorry, I didn't mean to cut you off but if you had any more questions than that...

[Question from Audience Member:]
Did you do any analysis between the different message patterns between I2P and Tor?
 
Oh, no I haven't done any, no. I see which is, you mean analysis on which one is preferred? 

Yeah

No, that would be a very interesting work that should be done because I feel like less people looked at I2P, that's usually the knock against it. But it would be interesting because they have an entirely - I think what he's referring to here is - they have an entirely different design in how they route messages throughout the network. So they use an asymmetric pattern. On Tor, the messages come and go over the same links, whereas I2P come over different links. So that has always felt like to me would be harder to analyze. But without actually going through and thinking through all the details, because you basically have to think through if I were writing a program to de-anonymize it, what would that look like? And, no I have not done that, sadly. So I don't know anybody that has, but if anybody knows...

[Question from Audience Member:]
So I've heard just kind of anecdotally that the Tor network is significantly larger than the I2P network just from being more popular-- 
Oh. That is a good point as well, yes.
--so I was curious if there's any way to get kind of, at least order of magnitude, estimate on the number of nodes in either of the networks so that you can kind of get an idea for what size botnet would be required to make a kind of successful attack against one or, either of the networks?

Oh, yeah the big thing is the amount of people covering your traffic there, the amount of plausible deniability. I don't know anyone that's analyzed those two networks, I'm sure there's information about that. I don't know it offhand.

[inaudible]

Oh, really? Right. Hold on one sec we should probably get back, you should probably get the mic.

[Audience member:]
Yeah, I was just saying it's about fifty thousand in I2P and about seven thousand in Tor but the major difference is that every user in I2P is also a router so that's a massive difference, and the Tor routers are just volunteers who setup nodes specifically for that purpose.

Right, so even though Tor has less nodes it probably has more bandwidth.

Correct.
 
Yeah, and I think their model of making everyone a router is much preferred, because one of the things now is if you're using Tor, this is probably why I don't know why the community originally selected I2P but one of the problems is that it also makes it even harder if you're routing out of people's data along with your own. That sort of makes things, even more complicated. So that's, yeah, so I mean, that's why I said at a glance I always felt like I2P is probably better in that regard because of several design traces but like I said I've never actually tried to think all of them through. 

Another long-time Monero [inaudible].

[Question from Audience Member:]
One question that came to my mind is, what happens if you set up a full Monero node but you don't use it for your own transactions? And then instead connect to another node to send your own transactions, so as, for example, to defeat your ISP spying on you, or at least confuse those some way. 

Yeah because then, I've thought about some of the techniques. One of the other issues I didn't even get to this talk, I probably thought I forgot about, there's all kinds of side channels where, if you're running a node here and I'm connecting on my phone back to my node at home, there's going to be a blip of my transaction size over some random SSL connection or whatever and then it immediately comes back out. So that might work but there's also the possibility, it depends how you get it to that user - that other node - and how aggressive the ISP is monitoring it. Because they'll see a connection, another connection going out of a similar size, but again it wouldn't be an easy correlation, but the correlation is there. But yeah. So those are my thoughts on that. Does that answer it well enough? 

Okay good.

[laughter]

[applause]



